<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>load_coda</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>&#x2f;</directory>
    <parameters>
    </parameters>
    <log>
<trans-log-table><connection/>
<schema/>
<table/>
<size_limit_lines/>
<interval/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>CHANNEL_ID</id><enabled>Y</enabled><name>CHANNEL_ID</name></field><field><id>TRANSNAME</id><enabled>Y</enabled><name>TRANSNAME</name></field><field><id>STATUS</id><enabled>Y</enabled><name>STATUS</name></field><field><id>LINES_READ</id><enabled>Y</enabled><name>LINES_READ</name><subject/></field><field><id>LINES_WRITTEN</id><enabled>Y</enabled><name>LINES_WRITTEN</name><subject/></field><field><id>LINES_UPDATED</id><enabled>Y</enabled><name>LINES_UPDATED</name><subject/></field><field><id>LINES_INPUT</id><enabled>Y</enabled><name>LINES_INPUT</name><subject/></field><field><id>LINES_OUTPUT</id><enabled>Y</enabled><name>LINES_OUTPUT</name><subject/></field><field><id>LINES_REJECTED</id><enabled>Y</enabled><name>LINES_REJECTED</name><subject/></field><field><id>ERRORS</id><enabled>Y</enabled><name>ERRORS</name></field><field><id>STARTDATE</id><enabled>Y</enabled><name>STARTDATE</name></field><field><id>ENDDATE</id><enabled>Y</enabled><name>ENDDATE</name></field><field><id>LOGDATE</id><enabled>Y</enabled><name>LOGDATE</name></field><field><id>DEPDATE</id><enabled>Y</enabled><name>DEPDATE</name></field><field><id>REPLAYDATE</id><enabled>Y</enabled><name>REPLAYDATE</name></field><field><id>LOG_FIELD</id><enabled>Y</enabled><name>LOG_FIELD</name></field><field><id>EXECUTING_SERVER</id><enabled>N</enabled><name>EXECUTING_SERVER</name></field><field><id>EXECUTING_USER</id><enabled>N</enabled><name>EXECUTING_USER</name></field><field><id>CLIENT</id><enabled>N</enabled><name>CLIENT</name></field></trans-log-table>
<perf-log-table><connection/>
<schema/>
<table/>
<interval/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>SEQ_NR</id><enabled>Y</enabled><name>SEQ_NR</name></field><field><id>LOGDATE</id><enabled>Y</enabled><name>LOGDATE</name></field><field><id>TRANSNAME</id><enabled>Y</enabled><name>TRANSNAME</name></field><field><id>STEPNAME</id><enabled>Y</enabled><name>STEPNAME</name></field><field><id>STEP_COPY</id><enabled>Y</enabled><name>STEP_COPY</name></field><field><id>LINES_READ</id><enabled>Y</enabled><name>LINES_READ</name></field><field><id>LINES_WRITTEN</id><enabled>Y</enabled><name>LINES_WRITTEN</name></field><field><id>LINES_UPDATED</id><enabled>Y</enabled><name>LINES_UPDATED</name></field><field><id>LINES_INPUT</id><enabled>Y</enabled><name>LINES_INPUT</name></field><field><id>LINES_OUTPUT</id><enabled>Y</enabled><name>LINES_OUTPUT</name></field><field><id>LINES_REJECTED</id><enabled>Y</enabled><name>LINES_REJECTED</name></field><field><id>ERRORS</id><enabled>Y</enabled><name>ERRORS</name></field><field><id>INPUT_BUFFER_ROWS</id><enabled>Y</enabled><name>INPUT_BUFFER_ROWS</name></field><field><id>OUTPUT_BUFFER_ROWS</id><enabled>Y</enabled><name>OUTPUT_BUFFER_ROWS</name></field></perf-log-table>
<channel-log-table><connection/>
<schema/>
<table/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>CHANNEL_ID</id><enabled>Y</enabled><name>CHANNEL_ID</name></field><field><id>LOG_DATE</id><enabled>Y</enabled><name>LOG_DATE</name></field><field><id>LOGGING_OBJECT_TYPE</id><enabled>Y</enabled><name>LOGGING_OBJECT_TYPE</name></field><field><id>OBJECT_NAME</id><enabled>Y</enabled><name>OBJECT_NAME</name></field><field><id>OBJECT_COPY</id><enabled>Y</enabled><name>OBJECT_COPY</name></field><field><id>REPOSITORY_DIRECTORY</id><enabled>Y</enabled><name>REPOSITORY_DIRECTORY</name></field><field><id>FILENAME</id><enabled>Y</enabled><name>FILENAME</name></field><field><id>OBJECT_ID</id><enabled>Y</enabled><name>OBJECT_ID</name></field><field><id>OBJECT_REVISION</id><enabled>Y</enabled><name>OBJECT_REVISION</name></field><field><id>PARENT_CHANNEL_ID</id><enabled>Y</enabled><name>PARENT_CHANNEL_ID</name></field><field><id>ROOT_CHANNEL_ID</id><enabled>Y</enabled><name>ROOT_CHANNEL_ID</name></field></channel-log-table>
<step-log-table><connection/>
<schema/>
<table/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>CHANNEL_ID</id><enabled>Y</enabled><name>CHANNEL_ID</name></field><field><id>LOG_DATE</id><enabled>Y</enabled><name>LOG_DATE</name></field><field><id>TRANSNAME</id><enabled>Y</enabled><name>TRANSNAME</name></field><field><id>STEPNAME</id><enabled>Y</enabled><name>STEPNAME</name></field><field><id>STEP_COPY</id><enabled>Y</enabled><name>STEP_COPY</name></field><field><id>LINES_READ</id><enabled>Y</enabled><name>LINES_READ</name></field><field><id>LINES_WRITTEN</id><enabled>Y</enabled><name>LINES_WRITTEN</name></field><field><id>LINES_UPDATED</id><enabled>Y</enabled><name>LINES_UPDATED</name></field><field><id>LINES_INPUT</id><enabled>Y</enabled><name>LINES_INPUT</name></field><field><id>LINES_OUTPUT</id><enabled>Y</enabled><name>LINES_OUTPUT</name></field><field><id>LINES_REJECTED</id><enabled>Y</enabled><name>LINES_REJECTED</name></field><field><id>ERRORS</id><enabled>Y</enabled><name>ERRORS</name></field><field><id>LOG_FIELD</id><enabled>N</enabled><name>LOG_FIELD</name></field></step-log-table>
<metrics-log-table><connection/>
<schema/>
<table/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>CHANNEL_ID</id><enabled>Y</enabled><name>CHANNEL_ID</name></field><field><id>LOG_DATE</id><enabled>Y</enabled><name>LOG_DATE</name></field><field><id>METRICS_DATE</id><enabled>Y</enabled><name>METRICS_DATE</name></field><field><id>METRICS_CODE</id><enabled>Y</enabled><name>METRICS_CODE</name></field><field><id>METRICS_DESCRIPTION</id><enabled>Y</enabled><name>METRICS_DESCRIPTION</name></field><field><id>METRICS_SUBJECT</id><enabled>Y</enabled><name>METRICS_SUBJECT</name></field><field><id>METRICS_TYPE</id><enabled>Y</enabled><name>METRICS_TYPE</name></field><field><id>METRICS_VALUE</id><enabled>Y</enabled><name>METRICS_VALUE</name></field></metrics-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>Y</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>Y</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
  <created_user>-</created_user>
  <created_date>2015&#x2f;04&#x2f;28 19&#x3a;12&#x3a;00.162</created_date>
  <modified_user>-</modified_user>
  <modified_date>2015&#x2f;04&#x2f;28 19&#x3a;12&#x3a;00.162</modified_date>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>CODA</name>
    <server>10.253.133.145</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>codaprod</database>
    <port>1521</port>
    <username>codauser</username>
    <password>Encrypted 2be98afc86aa7f2e4cb1aa174df9ea6cc</password>
    <servername/>
    <data_tablespace>codauser</data_tablespace>
    <index_tablespace>codauser</index_tablespace>
    <attributes>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>1521</attribute></attribute>
      <attribute><code>PRESERVE_RESERVED_WORD_CASE</code><attribute>N</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>Y</attribute></attribute>
      <attribute><code>SUPPORTS_TIMESTAMP_DATA_TYPE</code><attribute>Y</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>
    </attributes>
  </connection>
  <connection>
    <name>MASTER_DATA</name>
    <server/>
    <type>GENERIC</type>
    <access>Native</access>
    <database/>
    <port>1521</port>
    <username>sa</username>
    <password>Encrypted 2be98afc86aa7f2e4cb79ce10bef2bcdb</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>CUSTOM_DRIVER_CLASS</code><attribute>org.h2.Driver</attribute></attribute>
      <attribute><code>CUSTOM_URL</code><attribute>jdbc&#x3a;h2&#x3a;C&#x3a;&#x5c;Users&#x5c;CLANCE&#x5c;Documents&#x5c;Syncplicity Folders&#x5c;Livingston&#x5c;_Collections Initiative - Athena&#x5c;Data&#x5c;Integration&#x5c;db&#x5c;master_data&#x3b;AUTO_SERVER&#x3d;true&#x3b;AUTO_SERVER_PORT&#x3d;2039</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>1521</attribute></attribute>
      <attribute><code>PRESERVE_RESERVED_WORD_CASE</code><attribute>N</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>Y</attribute></attribute>
      <attribute><code>SUPPORTS_TIMESTAMP_DATA_TYPE</code><attribute>Y</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>
    </attributes>
  </connection>
  <connection>
    <name>PROC_DATA</name>
    <server/>
    <type>GENERIC</type>
    <access>Native</access>
    <database/>
    <port>1521</port>
    <username>sa</username>
    <password>Encrypted 2be98afc86aa7f2e4cb79ce10bef2bcdb</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>CUSTOM_DRIVER_CLASS</code><attribute>org.h2.Driver</attribute></attribute>
      <attribute><code>CUSTOM_URL</code><attribute>jdbc&#x3a;h2&#x3a;C&#x3a;&#x5c;Users&#x5c;CLANCE&#x5c;Documents&#x5c;Syncplicity Folders&#x5c;Livingston&#x5c;_Collections Initiative - Athena&#x5c;Data&#x5c;Integration&#x5c;db&#x5c;master_data&#x3b;AUTO_SERVER&#x3d;true&#x3b;AUTO_SERVER_PORT&#x3d;2039</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>1521</attribute></attribute>
      <attribute><code>PRESERVE_RESERVED_WORD_CASE</code><attribute>N</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>Y</attribute></attribute>
      <attribute><code>SUPPORTS_TIMESTAMP_DATA_TYPE</code><attribute>Y</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>
    </attributes>
  </connection>
  <order>
  <hop> <from>Query CODA</from><to>Load Extract</to><enabled>Y</enabled> </hop>
  </order>
  <step>
    <name>Load Extract</name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>MASTER_DATA</connection>
    <schema>MASTER_DATA</schema>
    <table>CUST_EXT_LOAD</table>
    <commit>1000</commit>
    <truncate>Y</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
    <fields>
    </fields>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>328</xloc>
      <yloc>108</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Query CODA</name>
    <type>UserDefinedJavaClass</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>

    <definitions>
        <definition>
        <class_type>TRANSFORM_CLASS</class_type>

        <class_name>Processor</class_name>

        <class_source><![CDATA[import org.pentaho.di.core.database.*;
import org.pentaho.di.core.variables.*;
import org.pentaho.di.trans.*;
import java.sql.*;
import java.io.*;
import java.util.*;
import oracle.jdbc.driver.*;

private final int MAX_PARAMS = 20;
private int[] paramIndexes;
private RowMetaInterface infoMeta = null;
private Database db = null;
private int maxRows = 0;
private int rowCount = 0;
private int fetchSize = 0;
private String procName = null;
private List procParams = null; 
private int cursorParamIndex = 0;
private RowSet infoStream = null;

// Overrides
public boolean processRow(StepMetaInterface smi, StepDataInterface sdi) throws KettleException
{
  Object[] infoRow = null;

  if (first) {
    if (procParams.size() > 0) {
      // Locate parameter value source
      infoStream = findInfoRowSet("PARAMETERS");
      
      if (infoStream == null) {
        // Can't continue without parameter values
        logError("Unable to find PARAMETERS InfoStream");
        setErrors(1);
        setOutputDone();
        return false;
      }
    }

    // Done with initialization
    first = false;
  }
  else {
    // We only run once for procedures with no parameters
    if (procParams.size() == 0) {
      setOutputDone();
      return false;    
    }
  }
   
  // If this procedure requires parameters, fetch values for them
  if (procParams.size() > 0) {
    // Get next set of parameter values (from InfoStep)
    logDebug("Fetching " + procParams.size() + " parameter values from PARAMETERS");
    infoRow = getRowFrom(infoStream);
    // Quit if none are available
    if (infoRow == null) {
      logDetailed("No more parameter values available from PARAMETERS");
      setOutputDone();
      return false;
    }
    
    if (infoMeta == null) {
      // Fetch parameter stream meta information
      infoMeta = infoStream.getRowMeta();
      if (infoMeta == null) {
        setErrors(1);
        logError("Unable to retrieve meta information from PARAMETERS");
        setOutputDone();
        return false;
      }
      
      // For each procedure parameter, identify the index in the info stream
      paramIndexes = new int[procParams.size()];
      logDebug("Mapping " + procParams.size() + " parameters");
      for (int p = 0; p < paramIndexes.length; p++) {
        // Use each parameter's name to look up it's index in the info stream
        String paramName = (String) procParams.get(p);
        logDebug("    Mapping " + paramName);
        paramIndexes[p] = infoMeta.indexOfValue(paramName);
      }
    }
  }
  else {
    infoRow = new Object[0]; // Empty array for procedures with no parameters
  }

  CallableStatement stmt=null;
  ResultSet rs=null;
  rowCount = 0;

  try
  {
    // Create a callable statement
    stmt = createStatement();
  
    // Execute the statement and fetch the result set
    rs = getResultSet(stmt, infoRow);
    rs.setFetchSize(fetchSize);
    rs.setFetchDirection(ResultSet.FETCH_FORWARD);
    logDetailed("Query completed. Fetching results...");

    RowMetaInterface rowMeta = null;
    DatabaseMeta dbMeta = null;
    
    // Fetch the first row from the result set
    while (rs.next() && ((rowCount < maxRows) || maxRows == 0)) {
     
      // Fetch the database row meta information from the first row
      if (rowMeta == null) {
        logDebug("Retrieving row meta information");
        dbMeta = db.getDatabaseMeta();
        rowMeta = db.getMetaFromRow(null, rs.getMetaData()); // getMetaFromRow does not use the provided row (as of PDI 5.1)

          // TODO: Validate returned fields vs. output fields
      }
      
      // Allocate an output row array
      Object[] outputRow = RowDataUtil.allocateRowData(rowMeta.size());
      
      // Set output values
      for (int f = 0; f < rowMeta.size(); f++) {
        ValueMetaInterface fromMeta = rowMeta.getValueMeta(f);
        ValueMetaInterface toMeta = data.outputRowMeta.getValueMeta(f);
        Object val = dbMeta.getValueFromResultSet(rs, fromMeta, f);

        // Convert to output type
        if (val != null) {
          if (val instanceof String) // Trim any string values before converting
            val = ((String)val).trim();
          outputRow[f] = toMeta.convertData(fromMeta, val);
        }
        else
          outputRow[f] = null;
      }

      // Write the row to the log
      logDebug("Read row: " + data.outputRowMeta.getString(outputRow));
      logRowlevel("Read row: " + data.outputRowMeta.getString(outputRow));

      // Pass the row to the next step
      putRow(data.outputRowMeta, outputRow);
      rowCount++;
    }
  } catch(Exception e) {
    throw new KettleException("Unable to execute stored procedure", e);
  } finally {
    if (rs != null) db.closeQuery(rs);
    if (stmt != null) db.closePreparedStatement(stmt);
  }

  // Signal that we are ready for more
	return true;
}

public boolean init(StepMetaInterface stepMetaInterface, StepDataInterface stepDataInterface)
{
  if (parent.initImpl(stepMetaInterface, stepDataInterface)) 
  {
    // Retrieve the name of the procedure to execute
    procName = getParameter("procName");
    if (procName != null && procName.trim().length() > 0) {
      
      // Check for maxRows parameter - limits number of rows returned
      String maxRowsParam = getParameter("maxRows");
      if (maxRowsParam != null && maxRowsParam.trim().length() > 0) {
        maxRows = Integer.parseInt(maxRowsParam);
        logDetailed("Max rows = " + maxRows);
      }
      
      // Check for fetchSize parameter - sets number of rows to fetch on each round-trip
      String fetchSizeParam = getParameter("fetchSize");
      if (fetchSizeParam != null && fetchSizeParam.trim().length() > 0) {
        fetchSize = Integer.parseInt(fetchSizeParam);
        logDetailed("Fetch size = " + fetchSize);
      }

      // Connect to the source database
      String connectionName = getParameter("connectionName");
      try{
        db = new Database(this.parent, getTransMeta().findDatabase(connectionName));
        db.shareVariablesWith(this.parent);
        db.connect();
        logDetailed("Connected to database [" + connectionName + "]");

        // Fetch parameter information for procedure
        logDetailed("Fetching Parameter Information for " + procName);
        procParams = getProcParams(procName);
        if (procParams != null)

        return true;
      }
      catch(KettleDatabaseException e){
          logError("Error connecting to " + connectionName + " - " + e.getMessage());
      }
    }
  }

  // Something went wrong...
  setErrors(1);
  stopAll();
  return false;
}

public void dispose(StepMetaInterface smi, StepDataInterface sdi)
{
    if (db != null) 
      db.disconnect();
    parent.disposeImpl(smi, sdi);
}

// Private members

private CallableStatement createStatement() throws Exception {

  // Assemble the query string
  String query = "{call " + procName + "(";
  for (int p = 0; p < procParams.size(); p++)
    query += "?,";    
  query += "?)}"; // Output parameter
 
	logDetailed("Query: '" + query + "'");

	// Create a callable statement.
	CallableStatement stmt = db.getConnection().prepareCall(query);

	return stmt;
}

private ResultSet getResultSet(CallableStatement stmt, Object[] r) throws Exception {

  // Set the output type to an Oracle Cursor
  stmt.registerOutParameter(cursorParamIndex + 1, OracleTypes.CURSOR);

	// Set the parameters...
	for (int p = 0; p < procParams.size(); p++) {
    int index = paramIndexes[p];
		ValueMetaInterface valueMeta = infoMeta.getValueMeta(index);
    Object valueData = r[index];
    db.setValue(stmt, valueMeta, valueData, p + 1);
	}

  if (fetchSize > 0) {
    logDetailed("Set fetch size : " + fetchSize);
    stmt.setFetchSize(fetchSize);
  }
  
 	// Execute the stored procedure...
	logDetailed("Executing : " + procName);
	stmt.execute();

	// Get the results...
  ResultSet rs = (ResultSet)stmt.getObject(cursorParamIndex + 1);

	return rs;
}

private List getProcParams(String procName)
{
  String[] nameParts = procName.split("\\.");
  if (nameParts.length > 2) {
    logError("Invalid procedure name: " + procName);
    return null;
  }
  procName = nameParts[nameParts.length - 1];

  // Fetch parameter information from the database
  ResultSet paramSet = null;
  String sql = "SELECT ARGUMENT_NAME, POSITION, DATA_TYPE, IN_OUT FROM USER_ARGUMENTS WHERE OBJECT_NAME = '" + procName + "' ";
  if (nameParts.length == 2)
    sql += " AND PACKAGE_NAME = '" + nameParts[0] + "' ";
  sql += " ORDER BY POSITION ASC";
  logDebug("Executing: " + sql);
  try {
    paramSet = db.openQuery(sql); // Execute SQL
  } catch(KettleDatabaseException e){
    logError("Error retrieving procedure parameters for " + procName + " - " + e.getMessage());
  }  
  
  List params = new ArrayList(MAX_PARAMS);
  try {
    for (Object[] row = db.getRow(paramSet); row != null; row = db.getRow(paramSet)) {
      if (row[3].equals("OUT")) {
        if (row[2].equals("REF CURSOR")) {
        cursorParamIndex = params.size();
        logDebug("Found Output Parameter at: " + cursorParamIndex);
        return params; // We don't support any more input parameters after this...
        }
        else {
          logError("Invalid output parameter type for procedure " + procName + " at position: " + row[1]);
          break;
        }
      }
      else {
        logDebug("Parameter " + params.size() + ": " + row[0]);
        params.add(row[0]);
      }
    }
    if (params.size() == 0)
      logError("Invalid procedure: " + procName);
    else // If we got here, we didn't find an OUT parameter...
      logError("Failed to find suitable output parameter type for procedure " + procName);
  } catch(KettleDatabaseException e){
    logError("Error retrieving procedure parameters for " + procName + " - " + e.getMessage());  
  } finally {
    db.closeQuery(paramSet);
  }
  
  return null;  
}
]]></class_source>
        </definition>
    </definitions>
    <fields>
        <field>
        <field_name>CUSTID</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>NAME</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>ADD1</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>ADD2</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>ADD3</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>CITY</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>STATEPROV</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>COUNTRY</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>POSTCODE</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>CREATEDATE</field_name>

        <field_type>Integer</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>TERMS</field_name>

        <field_type>Integer</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>CREDITLIM</field_name>

        <field_type>Integer</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>TTMREV</field_name>

        <field_type>Number</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>SFID</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>CORPCODE</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>CRLIMDATE</field_name>

        <field_type>Integer</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>ACCTSTAT</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>ACCTTYPE</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>BONDTYPE</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>PREVCO</field_name>

        <field_type>Integer</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>SIC</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>CST</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>CSM</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>MSD</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>SC</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>WAIVERTYPE</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>INVCURR</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>CREDITCODE</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>LANGUAGE</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>PARENT</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>REMITTO</field_name>

        <field_type>Integer</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>REMARKS1</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
        <field>
        <field_name>REMARKS2</field_name>

        <field_type>String</field_type>

        <field_length>-1</field_length>

        <field_precision>-1</field_precision>

        </field>
    </fields><clear_result_fields>N</clear_result_fields>
<info_steps></info_steps><target_steps></target_steps><usage_parameters><usage_parameter><parameter_tag>procName</parameter_tag>
<parameter_value>AR_EXTRACTS.CUSTOMER_MASTER_FULL</parameter_value>
<parameter_description/>
</usage_parameter><usage_parameter><parameter_tag>connectionName</parameter_tag>
<parameter_value>CODA</parameter_value>
<parameter_description/>
</usage_parameter><usage_parameter><parameter_tag>fetchSize</parameter_tag>
<parameter_value>10000</parameter_value>
<parameter_description/>
</usage_parameter><usage_parameter><parameter_tag>maxRows</parameter_tag>
<parameter_value>0</parameter_value>
<parameter_description/>
</usage_parameter></usage_parameters>     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>128</xloc>
      <yloc>108</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step_error_handling>
  </step_error_handling>
   <slave-step-copy-partition-distribution>
</slave-step-copy-partition-distribution>
   <slave_transformation>N</slave_transformation>

</transformation>
